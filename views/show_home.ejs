<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <title>ショーシフト管理システム</title>
    </head>
    <body>
        
        <script src = "../public/js/make_header.js" type="text/javascript"></script>
        <main>
            
            <div class="title">
                <h2><%= show_name %></h2>
            </div>
            <div>
                <p><a href= <%= "http://localhost:3000/show-report?show_id=" + show_id %>> シフト報告はこちらから</a></p>
                <% if(isLogin){ %>
                    <p><a href= <%= "http://localhost:3000/show/coeditor/request?show_id=" + show_id %>> 共同管理の申請はこちらから</a></p>
                <% } %>
            </div>
            <div class="shift-calender">
                <h3>シフト一覧</h3>
                <% 
                    //shift_resを日時をカギにした連想配列に変える
                    //ex -> {"yyyy/mm/dd tt:mm:ss":{"roll_name":"entertainer_name"}}
                    //ex -> {"yyyy/mm/dd tt:mm:ss":"tt_id"}
                    var shift = {}
                    var tt_id = {}
                    shift_res.forEach(s => {
                        if(s.day_and_time in shift){
                            //何もしない
                        }else{
                            shift[s.day_and_time] = {};
                            tt_id[s.day_and_time] = s.tt_id
                        }
                        shift[s.day_and_time][s.roll_name] = s.entertainer_name;
                    });
                %>
                <table border="2">
                    <thead>
                        <tr id="calendar">
                            <th> 役/日</th>
                            <!-- 日付生成 -->
                            <% for(var key in shift){  %>
                                <% var id = tt_id[key] %>
                                <% key = key.split(" "); %>
                                <% const ENG_TO_NUM_MONTH = {"Jan":1,"Feb":2,"Mar":3,"Apr":4,"May":5,"Jun":6,"Jul":7,"Aug":8,"Sep":9,"Oct":10,"Nov":11,"Dec":12}; %>
                                <% const ENG_TO_JA_DAY = {"Sun":"(日)","Mon":"(月)","Tue":"(火)","Wed":"(水)","Thu":"(木)","Fri":"(金)","Sat":"(土)"}; %>
                                <% if(isLogin){ %>
                                    <th> 
                                        <a href=<%= "http://localhost:3000/show-admin/shift-edit?show_id="+ show_id + "&tt_id=" + id %>>
                                            <%= key[3] + "/" + ENG_TO_NUM_MONTH[key[1]] + "/" + key[2] + 
                                            ENG_TO_JA_DAY[key[0]]%> <br>
                                            <%= key[4].slice(0,5) %> 
                                        </a>
                                    </th>
                                <% }else{ %>
                                    <th> 
                                        <%= key[3] + "/" + ENG_TO_NUM_MONTH[key[1]] + "/" + key[2] + 
                                        ENG_TO_JA_DAY[key[0]]%> <br>
                                        <%= key[4].slice(0,5) %> 
                                    </th>

                                <% } %>
                                
                            <%};%>
                             
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 一行目はthでヘッダー扱いにして役名一覧 -->
                        <% for(var i = 0; i< rolls.length ; i++ ) {%>
                            <tr>
                                <th>
                                    <%= rolls[i].roll_name %>
                                </th>
                                <!-- ここにシフトの内容を入れる -->
                                 <% for(var key in shift){ %>
                                    <td> <%= shift[key][rolls[i].roll_name] %></td>
                                <%};%>
                            </tr>
                        <% }; %>
                        <!-- 備考欄,未実装 -->
                        <tr>
                            <th>備考</th>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="admi-info">
                <h3>管理者からのお知らせ</h3>
                <table border="2">
                    <!-- テーブルでお知らせ一覧表示 -->
                    <tr>
                        <th>日時</th>
                        <th>件名</th>
                        <th>詳細</th>
                    </tr>
                    <% announce.forEach(an => { %>
                        <tr bgcolor="gray">
                            <td><%= an.d.toLocaleString().split(" ")[0] %><br>
                            <%= an.d.toLocaleString().split(" ")[1] %></td>
                            <td><%= an.title %></td>
                            <td><button id = <%= "open" + an.announce_id %> onClick="show_detail(this)" > 詳細表示</td>
                        </tr>
                        <tr id=<%= "content-" + an.announce_id %> style="display: none;">
                            <td colspan="2" ><%= an.content %></td>
                            <td><button id = <%= "close" + an.announce_id %> onClick="close_detail(this)" > 閉じる</td>
                        </tr>
                    <% }); %>
                </table>
                <script type="text/javascript">
                    function show_detail(e){
                        let id = e.id.slice(4);
                        document.getElementById("content-" + id).style.display = "";
                    }
                    function close_detail(e){
                        let id = e.id.slice(5);
                        document.getElementById("content-" + id).style.display = "none";
                    }
                </script>
            </div>
        </main>
   </body>
</html>